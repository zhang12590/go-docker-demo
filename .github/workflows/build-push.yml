name: Build and Push to GHCR

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  # 允许手动触发构建
  workflow_dispatch:
    inputs:
      tag:
        description: '镜像标签'
        required: false
        default: 'latest'

# 环境变量
env:
  REGISTRY: ghcr.io
  # 使用小写的仓库名
  IMAGE_NAME: ${{ github.repository_owner }}/go-logger-demo

jobs:
  # 1. 代码检查和测试
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Run Go vet
        run: go vet .
      
      - name: Run Go fmt check
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "代码需要格式化:"
            gofmt -l .
            exit 1
          fi
      
      - name: Build (验证可编译)
        run: go build -v .

  # 2. 构建和推送Docker镜像
  build-and-push:
    needs: lint-and-test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.meta.outputs.version }}
            BUILD_TIME=${{ steps.meta.outputs.created }}

  # 3. 生成部署清单
  generate-manifest:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate K8s manifest
        run: |
          # 设置镜像标签
          SHORT_SHA=${GITHUB_SHA:0:8}
          IMAGE_TAG="ghcr.io/${{ github.repository_owner }}/go-logger-demo:main-${SHORT_SHA}"
          
          # 创建包含镜像标签的K8s清单
          cat > k8s-manifest.yaml <<EOF
          # 自动生成的K8s部署清单
          # 生成时间: $(date)
          # 提交: ${GITHUB_SHA}
          # 镜像: ${IMAGE_TAG}
          
          apiVersion: v1
          kind: Namespace
          metadata:
            name: go-logger-demo
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: go-logger
            namespace: go-logger-demo
            labels:
              app: go-logger
              version: ${SHORT_SHA}
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: go-logger
            template:
              metadata:
                labels:
                  app: go-logger
                  version: ${SHORT_SHA}
              spec:
                containers:
                - name: go-logger
                  image: ${IMAGE_TAG}
                  imagePullPolicy: IfNotPresent
                  ports:
                  - containerPort: 8080
                    name: http
                  env:
                  - name: LOG_INTERVAL
                    value: "2"
                  - name: LOG_MESSAGE
                    value: "从GitHub Actions自动部署"
                  - name: HOSTNAME
                    valueFrom:
                      fieldRef:
                        fieldPath: spec.nodeName
                  resources:
                    requests:
                      memory: "64Mi"
                      cpu: "50m"
                    limits:
                      memory: "128Mi"
                      cpu: "200m"
                  livenessProbe:
                    httpGet:
                      path: /health
                      port: 8080
                    initialDelaySeconds: 10
                    periodSeconds: 30
                  readinessProbe:
                    httpGet:
                      path: /health
                      port: 8080
                    initialDelaySeconds: 5
                    periodSeconds: 10
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: go-logger-service
            namespace: go-logger-demo
          spec:
            type: ClusterIP
            selector:
              app: go-logger
            ports:
            - port: 80
              targetPort: 8080
              name: http
          ---
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: go-logger-ingress
            namespace: go-logger-demo
            annotations:
              kubernetes.io/ingress.class: nginx
              cert-manager.io/cluster-issuer: "letsencrypt-prod"
          spec:
            rules:
            - host: go-logger.your-domain.com
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: go-logger-service
                      port:
                        number: 80
            tls:
            - hosts:
              - go-logger.your-domain.com
              secretName: go-logger-tls
          EOF
          
          echo "生成的清单已保存到 k8s-manifest.yaml"
          cat k8s-manifest.yaml
      
      - name: Upload manifest artifact
        uses: actions/upload-artifact@v4
        with:
          name: k8s-manifest
          path: k8s-manifest.yaml